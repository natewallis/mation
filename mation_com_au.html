<head>
  <title>mation_com_au</title>
  <script src="js/media_uploader.js"></script>
  <script src="js/upload_video.js"></script>
</head>

<body>

  <div id="videoContainer">
    <video class="container-content" autoplay id="webcam"></video>
    <video class="container-content" id="preview"></video>
    <canvas class="container-content" id="webcamCanvas"></canvas>
    <div class="container-content onion-skin" id="onion1"></div>
    <div class="container-content onion-skin" id="onion2"></div>
    <div class="container-content onion-skin" id="onion3"></div>
  </div>

<script>

</script>

<script>

  var videoWidth = 800, videoHeight = 450;
  var realVideoWidth, realVideoHeight;
  var clientId = '809043913106-hda8s2ho0enhcnoeecus3q8gc6fcnf62.apps.googleusercontent.com';
  var apiKey = 'AIzaSyBMhflY8nb0z9SAU1Ff7AkDyVyoDVXEMxA';
  var scopes = 'https://www.googleapis.com/auth/youtube';
  var canvas, video, ctx, refreshInterval, images, videoFile,uploadVideo,previewURL, w,h;
  var uploadClick = 0;
  var onionSkin = 0, onionsAvailable = 3;
  var frameTotal = 0;

  function refreshOnions(){
    var onionCount = 1;
    for (var copyCount=frameTotal-1; copyCount>=Math.max(frameTotal - onionsAvailable, 0); copyCount--){
      var onionSkin = document.getElementById('onion' + onionCount);
      onionSkin.innerHTML = "";
      var img = document.createElement('img');
      img.src = images[copyCount];
      onionSkin.appendChild(img);
      onionCount++;
    }
  }
  
  function setOnions(amount){

    onionSkin = amount;

    for (var onionCount=1; onionCount<=onionsAvailable; onionCount++){
      if (onionCount <= amount){
        document.getElementById('onion' + onionCount).style.display = 'block';
      }else{
        document.getElementById('onion' + onionCount).style.display = 'none';
      }
    }

  }

  function handleClientLoad() {
    gapi.client.setApiKey(apiKey);
    window.setTimeout(checkAuth,1);
  }

  function checkAuth() {
    gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: true}, handleAuthResult);
  }

  function handleAuthResult(authResult) {
    if(authResult.access_token) {
      uploadVideo = new UploadVideo();
      uploadVideo.ready(authResult.access_token);
    }
  }

  $(function(){

    images = [];
    canvas = document.getElementById('webcamCanvas');
    canvas.width = videoWidth;
    canvas.height = videoHeight;
    ctx = canvas.getContext("2d");

    video = $("#webcam");

    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
    navigator.getUserMedia({video: true, audio:false}, 
      function(localMediaStream) {
        video = document.getElementById('webcam');
        video.src = window.URL.createObjectURL(localMediaStream);
        video.onloadedmetadata = function (e){
          realVideoWidth = video.videoWidth;
          realVideoHeight = video.videoHeight;
          refreshInterval = setInterval(function(){
            ctx.drawImage(video, (videoWidth - realVideoWidth) / 2, (videoHeight - realVideoHeight) / 2, realVideoWidth, realVideoHeight);
          }, 100);
        };
      },
      function(e){
       console.log("error", e);
      });

    $("#uploadButton").click(function handleAuthClick(event) {
      uploadClick++;
      if(uploadClick == 1){
        gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: false}, handleAuthResult);
      }else{
         uploadVideo.uploadFile(videoFile);
      }
    });


    $("#captureButton").click(function(e){
      var img = document.createElement('img');
      var encodedImage = canvas.toDataURL("image/webp");
      img.src = encodedImage;
      images.push(encodedImage);
      document.getElementById('filmstrip').appendChild(img);
      frameTotal++;
      refreshOnions();
    });

    $("#previewButton").click(function(e){
        var video = document.getElementById('preview');
        var preview = Whammy.fromImageArray(images, 24);
        videoFile = preview;
        previewURL = window.URL.createObjectURL(preview);
        video.src = previewURL;
        video.addEventListener('ended',function(e){
          video.style.display = "none";
          });
          video.style.display = "block";
          video.play();
    });

    $("#onionButton1").click(function(e){setOnions(1);});
    $("#onionButton2").click(function(e){setOnions(2);});
    $("#onionButton3").click(function(e){setOnions(3);});
    $("#onionOff").click(function(e){setOnions(0);});

  });

</script>

  <input id="onionButton1" type="button" value="ONION 1"/> 
  <input id="onionButton2" type="button" value="ONION 2"/> 
  <input id="onionButton3" type="button" value="ONION 3"/> 
  <input id="onionOff" type="button" value="ONION OFF"/> 
  <input id="captureButton" type="button" value="CAPTURE"/> 
  <input id="previewButton" type="button" value="PREVIEW"/> 
  <input id="uploadButton" type="button" value="UPLOAD"/> 
  <div id="filmstrip"></div>

<footer>
  <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
</footer>

</body>

